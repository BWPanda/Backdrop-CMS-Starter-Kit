services:
  php:
    image: tugboatqa/php:7-apache
    default: true
    depends: mysql
    
    commands:
      init:    
        - a2enmod headers rewrite
        
        - composer --no-ansi global require drush/drush:8.x
        - ln -sf ~/.composer/vendor/bin/drush /usr/local/bin/drush
        
        - mkdir -p ~/.drush/commands/ 
        - cd ~/.drush/commands/ && wget https://github.com/backdrop-contrib/drush/archive/1.x-0.x.zip
        - cd ~/.drush/commands/ && unzip 1.x-0.x.zip -d backdrop
        
        - drush download-backdrop backdrop
        - ln -snf "${TUGBOAT_ROOT}/backdrop" "${DOCROOT}"
        
        - drush -r "${DOCROOT}" site-install --db-url="mysql://tugboat:tugboat@mysql/tugboat" -y
        - drush -r "${DOCROOT}" user-password admin --password="${ADMIN_PWD}"
        
        - mkdir -p "${DOCROOT}/files"
        - chown www-data "${DOCROOT}/files"
        - chmod 744 "${DOCROOT}/files"
              
      build:
        - drush -r "${DOCROOT}" cache-clear all
        - drush -r "${DOCROOT}" updatedb -y
    
  mysql:
    image: tugboatqa/mysql:5
